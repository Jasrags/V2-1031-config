[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
  {% if printer['gcode_macro _USER_VARIABLE'].debug == 1 %}
    {action_respond_info('==== CANCEL_PRINT ====')}
    {action_respond_info('======================')}
  {% endif %}

  TURN_OFF_HEATERS
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  PRINT_END
  BASE_CANCEL_PRINT

# from vassssko
# [gcode_macro CANCEL_PRINT]
# description: Cancel the actual running print
# rename_existing: CANCEL_PRINT_BASE
# variable_execute: 'false'
# gcode:
#   ##### Get Boundaries #####
#   {% set max_x = printer.toolhead.axis_maximum.x|float %}
#   {% set max_y = printer.toolhead.axis_maximum.y|float %}
#   {% set max_z = printer.toolhead.axis_maximum.z|float %}
#   {% set act_x = printer.toolhead.position.x|float %}
#   {% set act_y = printer.toolhead.position.y|float %}
#   {% set act_z = printer.toolhead.position.z|float %}
#   ##### Get user defines #####
#   {% set purge_x = printer["gcode_macro _USER_VARIABLE"].purge_x %}
#   {% set purge_y = printer["gcode_macro _USER_VARIABLE"].purge_y %}

#   {% set add_temp = printer["gcode_macro _USER_VARIABLE"].extruder_min_add|int %}
#   {% set vent_on = printer["gcode_macro _USER_VARIABLE"].vent_on|int %}
#   {% set retract = printer["gcode_macro _USER_VARIABLE"].retract_cancel|float * -1 %}
#   {% set fan_off = printer['gcode_macro _USER_VARIABLE'].fan_run_after_print|int * 60 %}
#   {% set vent_off = printer['gcode_macro _USER_VARIABLE'].fan_run_after_print|int * 60 + 5 %}
#   ##### Get hardware enables #####
#   {% set ena_neo = printer['gcode_macro _USER_VARIABLE'].neo_display|lower %}
#   {% set ena_chamber = printer['gcode_macro _USER_VARIABLE'].chamber|lower %}
#   {% set ena_caselight = printer['gcode_macro _USER_VARIABLE'].caselight|lower %}
#   {% set ena_filter = printer['gcode_macro _USER_VARIABLE'].filter|lower %}
#   ##### store min and current extrution temp in variable ##### 
#   {% set extruder_min = printer.configfile.config.extruder.min_extrude_temp|int + add_temp %}
#   ##### Calculate save move #####
#   {% if act_x < (max_x - 20.0) %}
#     {% set x_safe = 20.0 %}
#   {% else %}
#     {% set x_safe = -20.0 %}
#   {% endif %}
#   {% if act_y < (max_y - 20.0) %}
#     {% set y_safe = 20.0 %}
#   {% else %}
#     {% set y_safe = -20.0 %}
#   {% endif %}
#   {% if act_z < (max_z - 2.0) %}
#     {% set z_safe = 2.0 %}
#   {% else %}
#     {% set z_safe = max_z - act_z %}
#   {% endif %}
#   ##### end of definitions #####
#   SET_GCODE_VARIABLE MACRO=CANCEL_PRINT VARIABLE=execute VALUE='"true"'
#   M117 Cancel
#   {% if printer.extruder.can_extrude|lower == 'false' %}
#       {action_respond_info("Extruder Temp to low heat to %2dC" % extruder_min)}
#       M109 S{extruder_min} ; heat extruder and wait
#   {% endif %}
#   M83
#   G1 E{retract} F1800
#   G91                                                       ; relative positioning
#   G0 X{x_safe} Y{y_safe} Z{z_safe} F20000 
#   TURN_OFF_HEATERS                                          ; turn off heaters
#   G90                                                       ; absolute positioning
#   G0 X{purge_x} Y{purge_y} F18000                           ; park nozzle at brush bin
#   M107                                                      ; turn off fan
#   {% if ena_chamber == 'fan' %} M141 S{vent_on} {% endif %} ; vent chamber (setting fan to below ambient)
#   _ADD_PRINT_TIME
#   _SD_PRINT_STATS R='canceled'
#   _SD_PRINTER_STATS
#   CANCEL_PRINT_BASE
#   {% if ena_neo == 'true' %} _LCD_KNOB COLOR=BLUE {% endif %}
#   {% if ena_caselight == 'true' %} _CASELIGHT_OFF {% endif %}
#   {% if ena_chamber == 'fan' %} UPDATE_DELAYED_GCODE ID=_DELAY_VENT_OFF DURATION={vent_off} {% endif %}
#   {% if ena_filter == 'true' %} UPDATE_DELAYED_GCODE ID=_DELAY_FILTER_OFF DURATION={fan_off} {% endif %}
#   UPDATE_DELAYED_GCODE ID=_DELAY_SDCARD_RESET_FILE DURATION=10
#   UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=10

# [delayed_gcode _EXECUTE_CANCEL_PRINT]
# gcode:
#   CANCEL_PRINT PARK=1 ERROR=1
